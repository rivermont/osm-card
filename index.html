<!DOCTYPE html>
<html lang="en_US">
<head>
    <meta charset="UTF-8">
    <title>OSM Business Card</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script>
    function gup (name) {
        name = RegExp ('[?&]' + name.replace (/([[\]])/, '\\$1') + '=([^&#]*)');
        return (window.location.href.match (name) || ['', ''])[1];
    }

    function buildCard (data) {
        // console.log(data.tags);
        // console.log(data.type);
        // console.log(data.id);

        // TODO: test for empty tags
        tags = data.tags;

        $('#name').html(tags.name);

        // Contact
        contact = [];

        // website
        // TODO strip url to domain for display
        if ('contact:website' in tags ) {
            contact.push('<i class="fa fa-globe"></i> <a href="' + tags['contact:website'] + '">website</a>');
        }
        else if ('website' in tags ) {
            contact.push('<i class="fa fa-globe"></i> <a href="' + tags['website'] + '">website</a>');
        }

        // phone
        if ('contact:phone' in tags) {
            contact.push('<i class="fa fa-phone"></i> <a href="tel:' + tags['contact:phone'] + '">' + tags['contact:phone'] + '</a>');
        }
        else if ('phone' in tags) {
            contact.push('<i class="fa fa-phone"></i> <a href="tel:' + tags['phone'] + '">' + tags['phone'] + '</a>');
        }

        // email
        if ('contact:email' in tags) {
            contact.push('<i class="fa fa-envelope"></i> <a href="mailto:' + tags['contact:email'] + '">' + tags['contact:email'] + '</a>');
        }
        else if ('email' in tags) {
            contact.push('<i class="fa fa-envelope"></i> <a href="mailto:' + tags['email'] + '">' + tags['email'] + '</a>');
        }

        // TODO fax
        // TODO facebook
        // TODO instagram
        // TODO twitter
        // TODO pinterest
        // TODO youtube

        $('#contact').html(contact.join('<br>'));

        // TODO opening hours (requires parsing function)

        // Address
        if ('addr:full' in tags) {
            $('#address').html(tags["addr:full"]);
        }
        else {
            addr = tags['addr:housenumber'] + '&nbsp;' + tags['addr:street'] + ',&nbsp;' + tags['addr:city'] + ',&nbsp;' + tags['addr:state'] + '&nbsp;' + tags['addr:postcode'];
            $('#address').html(addr);
        }

    }
    </script>
</head>
<body>
    <div id="card">
        <h1 id="name">Business Name</h1>
        <div id="contact"></div>
        <p id="address"></p>
    </div>
    <script>
    type = gup('type'); // TODO: combine these into one param
    id = gup('id');

    query = "[out:json][timeout:10];";

    if (type == 'n') {
        query = query + 'node(' + id + ');'
    }
    else if (type == 'w') {
        query = query + 'way(' + id + ');'
    }
    else if (type == 'r') {
        query = query + 'rel(' + id + ');'
    }
    else {
        throw new Error('Unknown type given.')
    }

    query += 'out tags;';

    $.getJSON('https://z.overpass-api.de/api/interpreter?data=' + query, function(data) {
        buildCard(data.elements[0]);
    });
    </script>
</body>
</html>